---
title: "Forecast daily electricity demand"
author: "Biz Yoder & Ryan McCord"
date: "2023-04-02"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,tidy.opts=list(width.cutoff=80), tidy=FALSE) 
```

```{r setup, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE, fig.align='center', echo=FALSE, include=FALSE}
#Import libraries
library(readxl) #import excel
library(dplyr) #pipes
library(forecast) #time series
library(ggplot2)
```

```{r, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE, fig.align='center'}
#Import load data
load <- read_excel(path="./Data/load.xlsx") 
```

```{r, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE, fig.align='center'}
#Find daily load (average of hourly values)
load_daily <- load %>%
  mutate(daily_load = rowMeans(select(load, starts_with('h')), na.rm = TRUE))
```

```{r, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE, fig.align='center'}
#Construct time series object
ts_daily <- msts(load_daily$daily_load, start = c(2005, 01, 01), end = c(2010, 12, 31),seasonal.periods = c(7,365.25))
```

## Modeling and Forecasting with complex seasonalities

We learned some approaches to model series with a single seasonal pattern.

* Moving Average, Naive Methods
* Simple Exponential smoothing
* Seasonal ARIMA
* State Space models
* ETS - Exponential smoothing state space model

Today we will learn a few examples of models for multiple seasonal patterns.

* ETS - another version of exponential smoothing (with 2 seasonal components)
* ARIMA with dynamic harmonic fourier components - ARIMA model that can deal with multiple seasonal components
* TBATS 
* Neural Network
```{r, warning=FALSE, message=FALSE, cache=TRUE, autodep=TRUE, fig.align='center'}
#Visualize data
summary(load_daily$daily_load)

ggplot(load_daily, aes(x=load_daily$date,y=load_daily$daily_load)) +
  geom_line() +
  xlab("Date") +
  ylab("Average Daily Household Power Demanded")
  
ts_daily %>% mstl() %>%
  autoplot()
```

```{r}
#Create train and test sets
one_year = 365 #leave out one year of data for testing
##Create train ts 
ts_daily_train <- subset(ts_daily, end = length(ts_daily)-one_year)


##Create test ts
ts_daily_test <- subset(ts_daily, start = length(ts_daily)-one_year)

autoplot(ts_daily_train)
autoplot(ts_daily_test)

```

```{r}
#Model 1 - STL + ETS model
ETS_fit <-  stlf(ts_daily_train,h=365)

#Plot foresting results
autoplot(ETS_fit) + ylab("Power Demand")

#Plot model + observed data
autoplot(ts_daily) +
  autolayer(ETS_fit, series="STL + ETS",PI=FALSE) +
  ylab("Power Demand")

#Run on full dataset to upload to Kaggle
ETS_fit_full <- stlf(ts_daily, h=59)
library(ggfortify)
model1_ets <- fortify(ETS_fit_full)
model1_ets_data <- model1_ets[1838:1896,4]
date <- seq(as.Date("2011-01-01"), as.Date("2011-02-28"), by = "days")

submission1 <- cbind.data.frame(date, model1_ets_data)
names(submission1) <- c("date", "load")

write.csv(submission1, "./Submissions/submission1.csv", row.names = FALSE)
```

```{r}
#Model 2 - ARIMA with fourier terms
ARIMA_four_fit <- auto.arima(ts_daily_train, 
                             seasonal=FALSE, #we don't want the ARIMA to try and model the complex seasonality
                             lambda=0,
                             xreg=fourier(ts_daily_train, 
                                          K=c(2,12)) 
                             )

ARIMA_four_for <- forecast(ARIMA_four_fit,
                           xreg=fourier(ts_daily_train,
                                        K=c(2,12),
                                        h=365), #telling it you also need a forecast for the fourier external regressors, not just the fit -- so you add the h=### piece inside the fourier() function
                           h=365
                           ) 

#Plot foresting results
autoplot(ARIMA_four_for) + ylab("Power")

#Plot model + observed data
autoplot(ts_daily) +
  autolayer(ARIMA_four_for, series="ARIMA_FOURIER",PI=FALSE) +
  ylab("Power")

ARIMA_four_full <- auto.arima(ts_daily, 
                             seasonal=FALSE, #we don't want the ARIMA to try and model the complex seasonality
                             lambda=0,
                             xreg=fourier(ts_daily, 
                                          K=c(2,12)) 
                             )

ARIMA_forecast_full <- forecast(ARIMA_four_full,
                           xreg=fourier(ts_daily,
                                        K=c(2,12),
                                        h=59), #telling it you also need a forecast for the fourier external regressors, not just the fit -- so you add the h=### piece inside the fourier() function
                           h=59
                           ) 

```

```{r}
model2 <- fortify(ARIMA_forecast_full)
model2_data <- model2[1838:1896,4]

submission2 <- cbind.data.frame(date, model2_data)
names(submission2) <- c("date", "load")

write.csv(submission2, "./Submissions/submission2.csv", row.names = FALSE)
```

```{r}
# TBATS can take time to fit
TBATS_fit <- tbats(ts_daily)

TBATS_for <- forecast(TBATS_fit, h=59)

model3 <- fortify(TBATS_for)
model3_data <- model3[1838:1896,4]

submission3 <- cbind.data.frame(date, model3_data)
names(submission3) <- c("date", "load")

write.csv(submission3, "./Submissions/submission3.csv", row.names = FALSE)

```

